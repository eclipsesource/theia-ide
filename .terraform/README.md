# Terraform

## Overview

- **main.tf**: This central Terraform configuration file contains variable definitions, and infrastructure components such as storage buckets, clusters, node pools, Helm installations, and Kubernetes resources required for the Theia IDE Preview powered by Theia Cloud.

- **backend.tf**: Configures the Terraform backend to use Google Cloud Storage for state storage, defined within a specific bucket. This is a remote storage so that the state is stored at a central location and shared between all terraform users.

- **versions.tf**: This file specifies the required providers, and provider versions for the Terraform configuration.

- **.terraform.lock.hcl**: Automatically generated by Terraform to lock the provider versions, ensuring consistent and reproducible Terraform operations.

- **outputs.tf**: This Terraform configuration file defines output variables for resources, such as the IP address for nginx and URLs for keycloak and launch pages, allowing easy lookup.

- **keycloak.yaml**: Helm values for the keycloak installation that are not secrets passed to the Terraform chart.

- **theia-cloud.yaml**: Helm values for the Theia Cloud installation that are not secrets passed to the Terraform chart.

## main.tf

1. Creates a Kubernetes Cluster
2. Reserves a public IP
3. Installs Cert-Manager
4. Installs NginX Ingress Controller
5. Installs Theia Cloud Base and CRDs
6. Installs Keycloak
7. Configures the Keycloak Realm, OpenId Client, Github OAuth Provider, and all other required Keycloak related settings
8. Installs Theia Cloud
9. Configures Service Accounts to use this cluster from the Github Workflow

## Commands to use the chart

```sh
## Prerequisite: Authenticate with Google Cloud

## change to terraform directory
cd .terraform

## initial setup / sync state with remote location
GOOGLE_OAUTH_ACCESS_TOKEN=$(gcloud auth print-access-token) terraform init

## apply changes
GOOGLE_OAUTH_ACCESS_TOKEN=$(gcloud auth print-access-token) terraform apply

# Troubleshooting

## Unlock remote storage
GOOGLE_OAUTH_ACCESS_TOKEN=$(gcloud auth print-access-token) terraform force-unlock <ID of the Lock Info>

## Import Browser Flow (find out id by changing something on this flow and checking the network tab in browser)
## https://theia-ide-preview.eclipsesource-munich.com/keycloak/admin/master/console/#/TheiaCloud/authentication -> browser flow -> change e.g. identity provider redirector -> inspect network
GOOGLE_OAUTH_ACCESS_TOKEN=$(gcloud auth print-access-token) terraform import keycloak_authentication_execution.browser TheiaCloud/browser/0aac893f-210e-4183-a649-b70753868ede

## Inspect browser flow to fill out state in main.tf
GOOGLE_OAUTH_ACCESS_TOKEN=$(gcloud auth print-access-token) terraform state show keycloak_authentication_execution.browser
```
